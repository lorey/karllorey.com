<!doctype html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>How to recover an AWS EC2 instance without the private key â€” Karl Lorey</title>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
          integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700|Playfair+Display:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="../../static/style.css">
    <script>
      var dnt = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      if (dnt != "1" && dnt != "yes") {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','__gaTracker');

        __gaTracker('create', 'UA-73074199-1', 'auto');
        __gaTracker('set', 'forceSSL', true);
        __gaTracker('set', 'anonymizeIp', true);
        __gaTracker('send','pageview');
      } else {
        console.debug("Respecting Do-Not-Track, not loading analytics. See https://www.paulfurley.com/google-analytics-dnt/");
      }
    </script>
</head>
<body>
<header>
    <p class="display-1"><a href="/">Karl Lorey</a></p>
    <nav>
        <ul class="nav justify-content-center">
            
            <li class="nav-link">
                <a href="../../techie/">Techie</a>
            </li>
            
            <li class="nav-link">
                <a href="../../founder/">Founder</a>
            </li>
            
            <li class="nav-link">
                <a href="../../vc/">Investor</a>
            </li>
            
            <li class="nav-link">
                <a href="../../speaker/">Speaker</a>
            </li>
            
            <li class="nav-link">
                <a href="../../human/">Human</a>
            </li>
            
            <li class="nav-link active">
                <a href="../../blog/">Lorey Ipsum</a>
            </li>
            
        </ul>
    </nav>
</header>
<div class="page">
    <hr style="margin-bottom: 50px">
    
  
  <div class="blog-post">
    <h1>How to recover an AWS EC2 instance without the private key</h1>
  <p class="meta">
    written by
    
      Karl Lorey
    
    on 2019-09-03
  </p>
  <p>Lost the private key for your EC2 instance and can't login via ssh anymore?
This tutorial will show you how to recover your EC2 instance by setting a new key pair to login.</p>
<p>What we'll do:</p>
<ul>
<li>mount the original instance's volume (a.k.a. it's filesystem) inside another temporary EC2 instance</li>
<li>modify the keys allowed to login</li>
<li>unmount the volume from the temporary instance and re-mount it in the original instance</li>
<li>login with a new key to your original instance</li>
</ul>
<p>In short, this replaces the key needed for ssh to connect with a new one of your choice.</p>
<h2>AWS Recovery Automation</h2>
<p>There's an <a href="https://aws.amazon.com/premiumsupport/knowledge-center/recover-access-lost-key-pair/">Amazon recovery automation thing</a> available that aims to recover your instance automatically,
it sadly did not work for me.
So here we go.</p>
<h2>Step 1: Find the instance</h2>
<p>Go to the AWS EC2 console and find your (lost) instance.
Make sure you're in the right availability zone.
Note down the instance ID as well as the subnet.
Also note the instance's volume</p>
<h2>Step 2: Create a temporary instance</h2>
<p>Launch an instance in the same availability zone.
Make sure to use the same subnet.
Create a new key pair with that instance
or use the key pair you'd like to use for your original instance from now on.</p>
<h2>Step 3: Attach the original volume to a temporary instance</h2>
<p>Stop the original instance to be able to unmount the storage.
Note the volume ID under <code>Attachment information</code>.
Go to volumes and detach the volume with <code>Actions - Detach Volume</code>.
Attach the volume to the temporary instance with <code>Actions - Attach Volume</code>.
Choose one of the given options and note it down, e.g. <code>/dev/sdf</code>.
Connect to the temporary instance via SSH and mount the volume, e.g. to <code>/data</code> via the following command:</p>
<pre><code>mount /dev/sdf /data
</code></pre>
<p>The volume of the original instance is now mounted to <code>/data</code>.
This allows us to now modify the allowed keys.</p>
<h2>Step 4: Modify the allowed keys</h2>
<p>We can now set the key of the current, temporary instance as an allowed key of the original instance.
The keys allowed to log in are stored in a file called <code>~/.ssh/authorized_keys</code> (background on <a href="https://www.ssh.com/ssh/authorized_keys/">authorized_keys</a>).
Inside this file is just a line-by-line list of authorized keys.
Because of this, we can just append the file of our temporary instance (and thus our key from the temporary instance)
to the file of our original instance.</p>
<pre><code>cat ~/.ssh/authorized_keys &gt;&gt; /data/home/admin/.ssh/authorized_keys
</code></pre>
<p>Make sure to swap admin with the actual user you want to sign in as (check your ssh connection command if you're unsure).</p>
<h3>Check if everything went right</h3>
<pre><code>cat /data/home/admin/.ssh/authorized_keys
</code></pre>
<p>should now contain the contents of:</p>
<pre><code>cat ~/.ssh/authorized_keys
</code></pre>
<h2>Step 4: Bring everything back in order</h2>
<p>We now have set up another key for login.
All that's left is to unmount the volume from the temporary instance and mount it to the original instance.</p>
<p>First, we have to unmout the storage of the original instance inside the temporary instance by
<code>umount /dev/sdf</code> (make sure to use the right path here).
Afterwards, you stop the temporary instance via the AWS console under <code>Instances</code>.
You then attach the volume to the original instance inside the AWS console under <code>Volumes</code> via <code>Actions - Attach volume</code>.
Type in the original instance ID as well as <code>xvda</code> as the mount point.
Otherwise, you might get an error pointing out that there's no root volume when starting the instance.
You can now re-start the original instance and should be able to login with the new key.</p>
<p>Make sure to delete the temporary instance in case everything went well.</p>
<h2>Conclusion</h2>
<p>So this guide showed you how to recover an AWS EC2 instance if you lose you private key.
We did this by using a temporary instance to swap or actually extend the authorized_keys file.
You should now be able to login to the original instance with your new key.</p>
<p>There's also a slightly different <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#replacing-lost-key-pair">guide by AWS</a>.</p>

  </div>


    <hr style="margin-top: 50px">
</div>
<footer>
    <p>I'm Karl Lorey&ndash;Techie, Founder, and Investor living in Karlsruhe, Germany. Let's get in touch.</p>
    <p class="lead socials">
        
            <a href="https://angel.co/karllorey" target="_blank"><i class="fab fa-angellist"></i></a>
        
            <a href="https://www.crunchbase.com/person/karl-lorey" target="_blank"><i class="fas fa-cube"></i></a>
        
            <a href="https://github.com/lorey" target="_blank"><i class="fab fa-github"></i></a>
        
            <a href="https://gitlab.com/lorey" target="_blank"><i class="fab fa-gitlab"></i></a>
        
            <a href="https://www.goodreads.com/karllorey" target="_blank"><i class="fab fa-goodreads"></i></a>
        
            <a href="https://www.instagram.com/karllorey" target="_blank"><i class="fab fa-instagram"></i></a>
        
            <a href="https://www.linkedin.com/in/karllorey" target="_blank"><i class="fab fa-linkedin"></i></a>
        
            <a href="https://medium.com/@karllorey" target="_blank"><i class="fab fa-medium"></i></a>
        
            <a href="https://www.meetup.com/members/196097665/" target="_blank"><i class="fab fa-meetup"></i></a>
        
            <a href="https://www.producthunt.com/@karllorey" target="_blank"><i class="fab fa-product-hunt"></i></a>
        
            <a href="https://www.researchgate.net/profile/Karl_Lorey" target="_blank"><i class="fab fa-researchgate"></i></a>
        
            <a href="https://twitter.com/karllorey" target="_blank"><i class="fab fa-twitter"></i></a>
        
    </p>
    <p>
        This site uses cookies and external services to improve your experience.<br>
        At least if you don't refuse by sending <a href="http://randomwalker.info/donottrack-archive/" target="_blank">Do Not Track</a>.
    </p>
    <p>&copy; Copyright 2018 by Karl Lorey. <a href="http://karllorey.de/impressum" target="_blank">Legal/Imprint</a>.</p>
</footer>
</body>
