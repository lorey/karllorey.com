<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Keeping Pandas DataFrames clean when importing JSON (with Context Managers) | Karl Lorey</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://karllorey.com/posts/keeping-pandas-dataframes-clean-importing-json/">
<!--[if lt IE 9]><script src="../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><meta name="author" content="Karl Lorey">
<link rel="prev" href="../year-in-review-2018/" title="Founding a Venture Capital Fund as a Techie: My Year 2018" type="text/html">
<link rel="next" href="../set-up-black-pycharm-ideavim/" title="How to set up Black with Debian, PyCharm, and IdeaVim" type="text/html">
<meta property="og:site_name" content="Karl Lorey">
<meta property="og:title" content="Keeping Pandas DataFrames clean when importing JSON (with Context Mana">
<meta property="og:url" content="https://karllorey.com/posts/keeping-pandas-dataframes-clean-importing-json/">
<meta property="og:description" content="At First Momentum, I do a lot of data analysis to find the most promising young startups.
As a first step, you always have to import the desired data into a Pandas DataFrame
and do some preprocessing,">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-03-03T10:30:13+01:00">
<meta property="article:tag" content="Clean Code">
<meta property="article:tag" content="Machine Learning">
<meta property="article:tag" content="Pandas">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Tech">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700%7CPlayfair+Display:400,700" rel="stylesheet">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="../../assets/css/style.css">
<script>
  var dnt = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
  if (dnt != "1" && dnt != "yes") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','__gaTracker');

    __gaTracker('create', 'UA-73074199-1', 'auto');
    __gaTracker('set', 'forceSSL', true);
    __gaTracker('set', 'anonymizeIp', true);
    __gaTracker('send','pageview');
  } else {
    console.debug("Respecting Do-Not-Track, not loading analytics. See https://www.paulfurley.com/google-analytics-dnt/");
  }
</script>
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><p id="brand" class="display-1">
        <a href="https://karllorey.com/" title="Karl Lorey" rel="home">

            <span id="blog-title">Karl Lorey</span>
        </a>
    </p>

            <nav><ul class="nav justify-content-center">
<li class="nav-link">
                <a href="../../techie/">Techie</a>
            </li>
            <li class="nav-link">
                <a href="../../founder/">Founder</a>
            </li>
            <li class="nav-link">
                <a href="../../vc/">Investor</a>
            </li>
            <li class="nav-link">
                <a href="../../speaker/">Speaker</a>
            </li>
            <li class="nav-link">
                <a href="../../human/">Human</a>
            </li>
            <li class="nav-link">
                <a href="../../blog/">Lorey Ipsum</a>
            </li>
        </ul></nav></header><main id="content" class="page"><hr style="margin-bottom: 50px">
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Keeping Pandas DataFrames clean when importing JSON (with Context Managers)</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Karl Lorey
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2019-03-03T10:30:13+01:00" itemprop="datePublished" title="2019-03-03">2019-03-03</time></a>
            </p>
                    <p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
        <div>
<p>At <a href="https://firstmomentum.vc">First Momentum</a>, I do a lot of data analysis to find the most promising young startups.
As a first step, you always have to import the desired data into a Pandas DataFrame
and do some preprocessing, for example by importing JSON data from some API. 
When doing this kind of pre-processing,
you usually have a lot of temporary columns in your DataFrame that get imported but need to be dropped later in the process.
To deal with these temporary columns,
I built a custom Context Manager that keeps track of all imported columns
and deletes them when you're done.
This way, your code stays lean and you don't have to remove temporary columns yourself.
In this short article, I will show how you can keep your pre-processing clean
and use a Python ContextManager to clean up temporary columns.</p>
<p>In this example I will use the actual code I use for importing data from the API of our CRM named Hubspot.
What I retrieve is a list of companies stored as a list of Python dictionaries.
To import a list of dictionaries in pandas you basically do:</p>
<pre class="code literal-block"><span></span><code><span class="kn">from</span> <span class="nn">pandas.io.json</span> <span class="kn">import</span> <span class="n">json_normalize</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">json_normalize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre>


<p>The json_normalize function generates a clean DataFrame based on the given <code>data</code> parameter and normalizes the hierarchy so you get clean column names.
This is especially useful for nested dictionaries.</p>
<h3>Ugly: Keeping imported columns</h3>
<p>The problem with json_normalize is that you usually only want a subset of the imported columns,
mostly with different names or some kind of pre-processing, too.
So you might be tempted to do something like this:</p>
<pre class="code literal-block"><span></span><code><span class="kn">from</span> <span class="nn">pandas.io.json</span> <span class="kn">import</span> <span class="n">json_normalize</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">json_normalize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">'company_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'companyId'</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'location'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'properties.city.value'</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'properties.name.value'</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'domain'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'properties.website.value'</span><span class="p">]</span>
<span class="o">//...</span> <span class="o">.</span><span class="n">apply</span><span class="p">(),</span> <span class="o">.</span><span class="n">as_type</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">whatever</span><span class="o">...</span>
</code></pre>


<p>This works, but keeps all the imported columns inplace and might take a lot of storage.
So what can you do?</p>
<h3>Ugly: Dropping columns manually</h3>
<p>So after importing, you want to get rid of all temporary columns from the import.
To do this, you have to either select the columns you want or drop all columns you don't want.
In both cases, you have to somehow keep track of the temporary columns or the ones you want to keep.
To deal with this, one solution would be to prefix temporary columns and delete them afterwards:</p>
<pre class="code literal-block"><span></span><code><span class="kn">from</span> <span class="nn">pandas.io.json</span> <span class="kn">import</span> <span class="n">json_normalize</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">json_normalize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="o">//</span> <span class="n">make</span> <span class="n">temporary</span> <span class="n">columns</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'temp_'</span> <span class="o">+</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="o">//</span> <span class="n">pre</span><span class="o">-</span><span class="n">processing</span><span class="p">,</span> <span class="n">basic</span> <span class="n">calculations</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'company_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'temp_companyId'</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'location'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'temp_properties.city.value'</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'temp_properties.name.value'</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'domain'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'temp_properties.website.value'</span><span class="p">]</span>
<span class="o">//...</span> <span class="o">.</span><span class="n">apply</span><span class="p">(),</span> <span class="o">.</span><span class="n">as_type</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">whatever</span><span class="o">...</span>
</code></pre>


<p>Afterwards, you would then select all desired columns or drop all undesired columns.</p>
<pre class="code literal-block"><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'temp_'</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">//</span> <span class="ow">or</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'temp_'</span><span class="p">)]]</span>
</code></pre>


<p>While this works, it feels bloated and inefficient.
You have to prefix all the value names in the code which results in bloated column names.
You also have to keep track of column names you want in the end
or the used prefix in different places.
Just imagine you have to change the prefix <code>temp_</code> one day or make the code work with a different prefix.</p>
<h3>Clean and easy: using a Context Manager</h3>
<p>After having used the above methods for some time, it struck me that <a href="https://jeffknupp.com/blog/2016/03/07/python-with-context-managers/">Python Context Managers</a> might be a cleaner solution.
You might know them from their most popular application <code>with open() as file:</code>.
If not, please take a few minutes to read more about them.
To make things short: They basically ensure that something, usually a cleanup, is executed in each exit scenario,
whether it is a usual exit like a return or an exception.
I thought I might use this to build a clean solution that keeps track and gets rid of temporary columns.
So I built a Context Manager that deals with temporary columns when importing JSON data so I don't have to.
You can basically use it like this:</p>
<pre class="code literal-block"><span></span><code><span class="k">with</span> <span class="n">DataFrameFromDict</span><span class="p">(</span><span class="n">companies</span><span class="p">)</span> <span class="k">as</span> <span class="n">df</span><span class="p">:</span>
    <span class="o">//</span> <span class="n">imported</span> <span class="nb">dict</span> <span class="n">now</span> <span class="ow">in</span> <span class="n">df</span><span class="p">,</span> <span class="n">same</span> <span class="n">result</span> <span class="k">as</span> <span class="n">json_normalize</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'company_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'companyId'</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'location'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'properties.city.value'</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'properties.name.value'</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">'domain'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">'properties.website.value'</span><span class="p">]</span>
<span class="o">//</span> <span class="n">after</span> <span class="n">context</span> <span class="n">exits</span><span class="p">,</span> <span class="n">df</span> <span class="n">contains</span> <span class="n">company_id</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="ow">and</span> <span class="n">domain</span>
<span class="o">//</span> <span class="n">but</span> <span class="n">no</span> <span class="n">more</span> <span class="n">temporary</span> <span class="n">columns</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre>


<p>The benefit: You don't have to keep track anymore and the context manager handles the deletion of all temporary columns.</p>
<h3>How it works</h3>
<p>You can just copy and paste the following snippet to get going, I'll explain how it works below:</p>
<pre class="code literal-block"><span></span><code><span class="k">class</span> <span class="nc">DataFrameFromDict</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Temporarily imports data frame columns and deletes them afterwards.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">json_normalize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre>


<p>When opening the context, <code>__init__</code> and <code>__enter__</code> get called.
They create the DataFrame and remember all imported and thus temporary column names.
When the context is exited, <code>__exit__</code> makes sure to drop all previously created columns
and leaves only the newly created columns behind.</p>
<p>Hope this helps you to create a clean pre-processing pipeline.
Let me know what you think.
You can find the <a href="https://gist.github.com/lorey/2b57b4ebfec4d45221e15a49060f80d2">code on GitHub</a>.</p>
<p>Further reading:</p>
<ul>
<li><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.io.json.json_normalize.html">json_normalize</a></li>
<li><a href="https://jeffknupp.com/blog/2016/03/07/python-with-context-managers/">Python Context Managers</a></li>
</ul>
</div>
    </div>

    <hr class="mt-5 mb-5">
<aside class="postpromonav"><nav><p class="mb-0">Tags:</p>
                    <ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/clean-code/" rel="tag">Clean Code</a></li>
            <li><a class="tag p-category" href="../../categories/machine-learning/" rel="tag">Machine Learning</a></li>
            <li><a class="tag p-category" href="../../categories/pandas/" rel="tag">Pandas</a></li>
            <li><a class="tag p-category" href="../../categories/python/" rel="tag">Python</a></li>
            <li><a class="tag p-category" href="../../categories/tech/" rel="tag">Tech</a></li>
        </ul>
<p class="mb-0">Posts:</p>
                    <ul class="pager hidden-print">
<li class="previous">
                <a href="../year-in-review-2018/" rel="prev" title="Founding a Venture Capital Fund as a Techie: My Year 2018">Previous post</a>
            </li>
            <li class="next">
                <a href="../set-up-black-pycharm-ideavim/" rel="next" title="How to set up Black with Debian, PyCharm, and IdeaVim">Next post</a>
            </li>
        </ul></nav></aside></article><hr style="margin-top: 50px"></main><nav><ul class="nav justify-content-center">
<li class="nav-link">
                 <a href="../../archive.html">Archive</a>
             </li>
             <li class="nav-link">
                 <a href="../../categories/">Categories</a>
             </li>
             <li class="nav-link">
                 <a href="../../rss.xml">RSS feed</a>
             </li>
         </ul></nav><footer><p>I'm Karl Lorey–Techie, Founder, and Investor living in Karlsruhe, Germany. Let's get in touch.</p>
    <p class="lead socials">
            <a href="https://angel.co/karllorey" target="_blank"><i class="fab fa-angellist"></i></a>
            <a href="https://www.crunchbase.com/person/karl-lorey" target="_blank"><i class="fas fa-cube"></i></a>
            <a href="https://github.com/lorey" target="_blank"><i class="fab fa-github"></i></a>
            <a href="https://gitlab.com/lorey" target="_blank"><i class="fab fa-gitlab"></i></a>
            <a href="https://www.goodreads.com/karllorey" target="_blank"><i class="fab fa-goodreads"></i></a>
            <a href="https://www.instagram.com/karllorey" target="_blank"><i class="fab fa-instagram"></i></a>
            <a href="https://www.linkedin.com/in/karllorey" target="_blank"><i class="fab fa-linkedin"></i></a>
            <a href="https://medium.com/@karllorey" target="_blank"><i class="fab fa-medium"></i></a>
            <a href="https://www.meetup.com/members/196097665/" target="_blank"><i class="fab fa-meetup"></i></a>
            <a href="https://www.producthunt.com/@karllorey" target="_blank"><i class="fab fa-product-hunt"></i></a>
            <a href="https://www.researchgate.net/profile/Karl_Lorey" target="_blank"><i class="fab fa-researchgate"></i></a>
            <a href="https://twitter.com/karllorey" target="_blank"><i class="fab fa-twitter"></i></a>
    </p>
    <p>
        This site uses cookies and external services to improve your experience.<br>
        At least if you don't refuse by sending <a href="http://randomwalker.info/donottrack-archive/" target="_blank">Do Not Track</a>.
    </p>
    <p>© Copyright 2020 by Karl Lorey. <a href="http://karllorey.de/impressum" target="_blank">Legal/Imprint</a>.</p>
</footer>
</div>
                <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
